# Подробное описание кода

В этом документе приведено детальное объяснение структуры репозитория и того, как работают основные функции. Цель – дать полное понимание текущей реализации, чтобы в дальнейшем можно было определить, какие изменения требуются.

## Корень проекта
- **package.json / package-lock.json** – конфигурация npm и список зависимостей.
- **tsconfig.json** – параметры TypeScript.
- **tailwind.config.js / postcss.config.js** – минимальная настройка Tailwind CSS.
- **.env** – включает `TSC_COMPILE_ON_ERROR=true`, что позволяет запускать проект при наличии ошибок типизации.
- **server.log** – лог запуска dev‑сервера.
- **README.md** – стандартный текст Create React App.
- **CLAUDE.md** – пояснения по запуску и краткий обзор архитектуры.

## Директория `src`
Основная логика приложения. Ниже описаны все файлы и функции.

### `index.tsx`
Точка входа. Рендерит компонент `<App />` в `#root` с помощью `ReactDOM.createRoot`.

### `App.tsx`
Оборачивает всё приложение в `FinancialProvider`. По сути это контейнер, который подключает контекст и глобальные стили.

### `FinancialDashboard.tsx` (устаревшая версия)
Ранее содержал всю логику в одном файле. Сейчас хранится для справки.

### `components/`
Содержит переиспользуемые компоненты и основные панели.

#### `components/common`
- **EditableCell.tsx** – компонент `<input type="number">` c валидацией. Функция `handleChange` проверяет введённое число и вызывает `onChange` при корректном значении.
- **InfoTooltip.tsx** – всплывающая подсказка. Управляет видимостью через `useState`. Функции `getPositionClasses` и `getArrowClasses` вычисляют CSS‑классы для позиционирования.
- **MetricCard.tsx** – карточка метрики. Внутри есть функции `defaultFormatCurrency`, `getTrendColor`, `getTrendIcon`. Компонент отображает значение, иконку тренда и текст подсказки.

#### `components/charts`
Каждый график использует библиотеку Recharts.
- **RevenueChart.tsx** – отображает динамику доходов. Используются градиенты `linearGradient` и `<Area>` для разных источников. Через `useFinancialContext` берёт данные, если `propData` не переданы. Tooltip форматирует значения функцией `currency` из `useFormatting`.
- **ClientsChart.tsx** – показывает количество клиентов по тарифам. Опциональный параметр `showAllGroups` управляет отображением групп. При `true` рендерятся пять `<Area>` по тарифам, иначе только общее количество.
- **KPIRadarChart.tsx** – радарная диаграмма ключевых метрик. Данные нормализуются в массив `normalizedData`, затем строятся пять лучей (`<Radar>`) для ROI, NRR и др.

#### `components/panels`
Панели для редактирования параметров и отображения метрик.
- **SettingsPanel.tsx** – блок «Параметры финансовой модели». Содержит обработчики `setTaxMode`, `setFotMode` и поля для изменения цен подписки, стоимости внедрения, CAC и др. Использует `EditableCell` и слайдеры `<input type="range">`.
- **ClientsEditor.tsx** – таблица ввода новых клиентов по месяцам. Вспомогательная функция `updateClientArray` обновляет массивы в состоянии контекста.
- **FOTEditor.tsx** – редактирование фонда оплаты труда. Аналогично ClientsEditor имеет `updateFOTArray` для изменения значений по месяцам.
- **UpsellSettingsPanel.tsx** – управление параметрами upsell (дополнительные боты, функции, сообщения, интеграции). Каждая секция показывает текущий доход от соответствующего вида upsell.
- **KeyMetricsPanel.tsx** – вывод основных метрик. Использует `MetricCard` для отображения общей выручки, расходов, ROI, количества клиентов и т.д.

### `constants/`
- **DefaultValues.ts** – содержит начальные параметры модели: цены подписок, количество сообщений, ставки налогов, массивы ФОТ и пр.
- **FormatOptions.ts** – набор функций `formatCurrency`, `formatPercent`, `formatNumber` и соответствующие опции форматирования.
- **Theme.ts** – палитра цветов приложения и преднастроенные градиенты `chartGradients`.

### `contexts/FinancialContext.tsx`
Главный контекст, хранящий состояние финансовой модели. Внутри определены десятки `useState` для всех параметров (налоги, клиенты, ФОТ, интеграция, CAC, Upsell). После инициализации значений формируется объект `modelParams`, `clientsData` и `upsellSettings`. Затем вызывается кастомный хук `useFinancialModel`, который возвращает `monthlyData`, `totalData` и функцию `calculateFinancialModel`.

`useEffect` следит за всеми зависимостями и пересчитывает модель при изменении любых параметров. Контекст предоставляет методы‑сеттеры и данные для использования в компонентах.

### `hooks/useFinancialModel.ts`
Ключевой расчётный модуль. Хук принимает `FinancialModelParams`, `ClientsData` и `UpsellSettings`.
- Создаёт состояния `monthlyData` и `totalData`.
- Функция `calculateFinancialModel` выполняет цикл по 12 месяцам, рассчитывая:
  - количество активных/новых/отток клиентов;
  - выручку от внедрения, подписок и дополнительных сообщений;
  - доход от upsell по четырём направлениям;
  - расходы на API, CAC, внедрение, ФОТ и прочее;
  - валовую и чистую прибыль, налоги, NRR, ARPU;
  - накопительные итоги по выручке, расходам и прибыли.
- По завершении вычисляет итоговые показатели (LTV, ROI, маржа внедрения, breakeven и т.д.) и обновляет состояния.
- Возвращает `monthlyData`, `totalData` и саму функцию `calculateFinancialModel`.

### `hooks/useFormatting.ts`
Обёртка над функциями форматирования. С помощью `useMemo` возвращает объект из трёх функций: `currency`, `percent`, `number`.

### `types/FinancialTypes.ts`
Определяет все интерфейсы и типы данных для модели: `MonthlyData`, `TotalData`, `FinancialModelParams`, `ClientsData`, `UpsellSettings`, а также типы `TaxMode` и `FOTMode`.

### `tests/`
Набор тестов на Jest + React Testing Library. Покрывают компоненты (`EditableCell`, `MetricCard`, `InfoTooltip`) и работу хука `useFinancialModel`.

## Взаимосвязь компонентов
1. **FinancialProvider** из `FinancialContext.tsx` инициализирует все состояния и передаёт их потомкам через контекст.
2. Компонент `FinancialDashboard` потребляет этот контекст, отображает панели (SettingsPanel, ClientsEditor и т.д.) и графики.
3. Любое изменение в панелях обновляет состояние контекста, что вызывает пересчёт модели в `useFinancialModel` через `useEffect`.
4. Пересчитанные данные (`monthlyData`, `totalData`) попадают обратно в компоненты графиков и карточек, заставляя их перерисоваться.

## Заключение
Текущий проект представляет собой монолитную финансовую модель с контекстом и кастомным хуком для расчётов. Все данные хранятся в едином провайдере, а UI разбит на панели для удобства редактирования. Дальнейшие улучшения могут включать оптимизацию вычислений, разбивку на модули и расширение тестового покрытия.
