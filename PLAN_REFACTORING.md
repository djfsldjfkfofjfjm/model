# План рефакторинга FinancialDashboard.tsx

## 1. Разделение на модульную архитектуру

### 1.1. Создание отдельных файлов для компонентов

#### Базовые UI компоненты
- `src/components/common/EditableCell.tsx`
  - Вынести логику редактируемой ячейки
  - Добавить типизацию для всех пропсов
  - Добавить дополнительные валидации ввода

- `src/components/common/InfoTooltip.tsx`
  - Вынести компонент подсказок
  - Добавить возможность позиционирования подсказки
  - Добавить поддержку разных стилей подсказок

- `src/components/common/MetricCard.tsx`
  - Вынести карточку метрики
  - Добавить возможность настройки стилей карточки
  - Добавить поддержку разных форматов данных

#### Компоненты графиков
- `src/components/charts/RevenueChart.tsx`
  - Вынести график доходов
  - Переработать пропсы для гибкой настройки
  - Добавить дополнительные варианты отображения

- `src/components/charts/ClientsChart.tsx`
  - Вынести график клиентов
  - Добавить возможность фильтрации по типам клиентов
  - Улучшить механизм масштабирования

- `src/components/charts/KPIRadarChart.tsx`
  - Вынести радарный график KPI
  - Добавить настройку отображаемых метрик
  - Улучшить нормализацию данных для графика

#### Панели настроек и редакторы
- `src/components/panels/SettingsPanel.tsx`
  - Вынести панель основных настроек
  - Разделить на логические блоки
  - Добавить группировку настроек

- `src/components/panels/UpsellSettingsPanel.tsx`
  - Вынести панель настроек Upsell
  - Переработать интерфейс для лучшей наглядности
  - Добавить визуализацию зависимостей между параметрами

- `src/components/panels/ClientsEditor.tsx`
  - Вынести редактор клиентов
  - Добавить функции массового редактирования
  - Улучшить UX для работы с таблицей клиентов

- `src/components/panels/FOTEditor.tsx`
  - Вынести редактор ФОТ
  - Добавить возможность импорта/экспорта данных
  - Улучшить интерфейс редактирования

- `src/components/panels/KeyMetricsPanel.tsx`
  - Вынести панель ключевых метрик
  - Добавить возможность настройки отображаемых метрик
  - Улучшить визуальное отображение метрик

### 1.2. Структурирование бизнес-логики

#### Хуки для бизнес-логики
- `src/hooks/useFinancialCalculations.ts`
  - Вынести основные расчеты финансовой модели
  - Разбить большую функцию расчета на модульные подфункции
  - Добавить строгую типизацию для входных и выходных данных
  - Оптимизировать пересчеты с помощью мемоизации

- `src/hooks/useClientManagement.ts`
  - Вынести логику управления клиентской базой
  - Реализовать функции для изменения клиентов по группам
  - Добавить расчеты динамики клиентской базы

- `src/hooks/useUpsellManagement.ts`
  - Вынести логику управления upsell
  - Добавить функции для разных стратегий upsell
  - Реализовать прогнозирование по разным сценариям

- `src/hooks/useFinancialSettings.ts`
  - Централизовать управление финансовыми настройками
  - Добавить функции предустановок для быстрой смены стратегий
  - Реализовать валидацию параметров

#### Утилиты и вспомогательные функции
- `src/utils/calculationUtils.ts`
  - Вынести вспомогательные функции для расчетов
  - Добавить функции для анализа чувствительности
  - Реализовать утилиты для финансовых расчетов

- `src/utils/formatters.ts`
  - Вынести форматтеры данных
  - Реализовать различные варианты форматирования для разных типов данных
  - Добавить интернационализацию

### 1.3. Выделение типов и констант

#### Типы данных
- `src/types/FinancialTypes.ts`
  - Определить интерфейсы для всех используемых данных
  - Добавить типы для параметров модели и результатов расчетов
  - Определить типы для конфигурации компонентов

#### Константы
- `src/constants/DefaultValues.ts`
  - Вынести все начальные значения переменных
  - Сгруппировать по логическим блокам
  - Добавить документацию по всем параметрам

- `src/constants/Theme.ts`
  - Вынести цветовую схему и тему оформления
  - Определить стили для основных элементов
  - Создать темную тему как альтернативу

## 2. Реорганизация управления состоянием

### 2.1. Создание контекста для глобального состояния

- `src/context/FinancialContext.tsx`
  - Создать контекст для глобального состояния модели
  - Реализовать провайдер контекста
  - Добавить типизацию контекста

- `src/reducers/financialReducer.ts`
  - Создать редюсер для управления состоянием
  - Разделить на отдельные обработчики по типам действий
  - Добавить механизм отмены/повтора действий

### 2.2. Фрагментация состояния на логические группы

- Создать отдельные редюсеры для различных аспектов модели:
  - `src/reducers/modelParamsReducer.ts` - базовые параметры модели
  - `src/reducers/clientsReducer.ts` - клиентские данные
  - `src/reducers/upsellReducer.ts` - параметры upsell
  - `src/reducers/resultsReducer.ts` - результаты расчетов

- Реализовать комбинированный редюсер

### 2.3. Использование локального состояния для UI-компонентов

- Оставить локальное состояние только для компонентов UI:
  - Состояние открытых/закрытых секций
  - Состояние редактирования полей
  - Временные UI состояния

## 3. Оптимизация производительности

### 3.1. Мемоизация компонентов

- Обернуть все карточки и графики в React.memo
- Добавить проверку эквивалентности пропсов для предотвращения ненужных рендеров
- Использовать useMemo для подготовки данных для графиков

### 3.2. Оптимизация вычислений

- Перестроить зависимости в useCallback для предотвращения лишних пересчетов
- Создать механизм инкрементальных расчетов (пересчитывать только изменившиеся части)
- Использовать кэширование промежуточных результатов

### 3.3. Оптимизация рендеринга

- Реализовать ленивую загрузку компонентов с React.lazy и Suspense
- Внедрить виртуализацию для таблиц с большим количеством данных
- Использовать React.Profiler для измерения производительности и выявления узких мест

## 4. Улучшение типизации

### 4.1. Определение интерфейсов для всех данных

- Создать полный набор типов данных:
  ```typescript
  interface MonthlyData {
    month: number;
    // Клиенты
    newClients75: number;
    newClients150: number;
    // ... другие поля
  }

  interface FinancialSettings {
    taxMode: 'optimistic' | 'pessimistic';
    fotMode: 'optimistic' | 'pessimistic';
    // ... другие настройки
  }

  interface ClientsState {
    // Текущее состояние клиентской базы
  }

  interface FinancialResults {
    // Результаты финансовых расчетов
  }
  ```

### 4.2. Строгая типизация пропсов компонентов

- Определить типы пропсов для всех компонентов
- Добавить валидацию пропсов
- Использовать Discriminated Unions для сложных случаев

### 4.3. Устранение использования типа `any`

- Заменить все использования `any` на конкретные типы
- Использовать Generic-типы где необходимо
- Добавить Type Guards для безопасного приведения типов

## 5. Улучшение поддерживаемости кода

### 5.1. Добавление документации

- Добавить JSDoc комментарии ко всем функциям и компонентам
- Создать README-файлы для каждой директории с описанием их назначения
- Документировать сложные алгоритмы и бизнес-логику

### 5.2. Унификация стиля кода

- Разработать и применить единый стиль именования
- Стандартизировать подход к обработке ошибок
- Согласовать структуру компонентов

### 5.3. Модульные тесты

- Разработать тесты для основных компонентов и функций
- Создать снэпшоты для компонентов UI
- Тестировать бизнес-логику с разными наборами входных данных

## 6. Расширяемость для будущих изменений

### 6.1. Поддержка подключаемых плагинов

- Разработать интерфейс для плагинов
- Реализовать механизм регистрации и использования плагинов
- Добавить документацию по созданию плагинов

### 6.2. Настраиваемый пользовательский интерфейс

- Добавить сохранение пользовательских настроек в localStorage
- Реализовать компонент для настройки отображения
- Добавить пресеты настроек UI

### 6.3. Добавление API для внешних интеграций

- Создать API для доступа к данным и расчетам
- Реализовать экспорт данных в различные форматы
- Добавить документацию по интеграции

## План реализации

### Этап 1: Подготовительный (1-2 дня)
- Создать структуру директорий
- Определить типы и интерфейсы
- Подготовить контекст и базовые редюсеры

### Этап 2: Выделение базовых компонентов (2-3 дня)
- Реализовать базовые UI компоненты
- Создать хуки для бизнес-логики
- Вынести константы и утилиты

### Этап 3: Реорганизация логики (3-4 дня)
- Реализовать компоненты панелей и редакторов
- Подключить компоненты к контексту
- Разбить основной компонент на части

### Этап 4: Интеграция и тестирование (2-3 дня)
- Соединить все компоненты
- Провести ручное тестирование
- Автоматизировать тесты для критических компонентов

### Этап 5: Оптимизация и финализация (2-3 дня)
- Оптимизировать производительность
- Дополнить документацию
- Рефакторинг и финальная проверка