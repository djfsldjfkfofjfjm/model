# Анализ проекта Financial Dashboard

Дата анализа: 20.05.2025

## 1. Обзор проекта

Проект представляет собой веб-приложение для финансового моделирования SaaS-бизнеса. Пользователь может настраивать различные параметры (цены, затраты, привлечение клиентов, отток и т.д.) и видеть рассчитанные финансовые показатели, представленные в виде таблиц и графиков.

**Технологический стек:**
*   React 19
*   TypeScript (версия ~4.9.5)
*   Create React App (используются `react-scripts`)
*   Tailwind CSS для стилизации
*   Recharts для графиков
*   ESLint для линтинга (базовая конфигурация `react-app`)

## 2. Структура проекта

Основные директории и файлы:

*   **`public/`**: Статические ассеты, `index.html`.
*   **`src/`**: Исходный код приложения.
    *   **`App.tsx`**: Корневой компонент, оборачивает `FinancialDashboard` в `FinancialProvider`.
    *   **`FinancialDashboard.tsx`**: Находится в `src/FinancialDashboard.tsx`. **Это устаревшая или неиспользуемая версия компонента**, содержащая всю логику и UI в одном файле. Анализ этого файла был проведен, но он не отражает актуальную структуру приложения.
    *   **`index.tsx`**: Точка входа React-приложения.
    *   **`components/`**: Директория с переиспользуемыми UI-компонентами.
        *   `FinancialDashboard.tsx`: Находится в `src/components/FinancialDashboard.tsx`. **Это актуальный основной компонент дашборда**, который используется в `App.tsx`. Он отвечает за UI и использует `FinancialContext` для получения данных и управления состоянием.
        *   `charts/`: Компоненты для графиков (например, `RevenueChart.tsx`, `ClientsChart.tsx`, `KPIRadarChart.tsx`). Их код не был прочитан.
        *   `common/`: Общие компоненты (например, `EditableCell.tsx`, `InfoTooltip.tsx`, `MetricCard.tsx`). Их код не был прочитан.
        *   `panels/`: Компоненты для панелей настроек (например, `SettingsPanel.tsx`, `ClientsEditor.tsx`, `FOTEditor.tsx`, `UpsellSettingsPanel.tsx`). Их код не был прочитан.
    *   **`constants/`**: Константы, включая значения по умолчанию для модели (`DefaultValues.ts`).
    *   **`contexts/`**: React Context для управления состоянием.
        *   `FinancialContext.tsx`: Провайдер и хук для доступа к финансовым данным и параметрам модели. Централизует состояние и логику обновления.
    *   **`hooks/`**: Кастомные React хуки.
        *   `useFinancialModel.ts`: Хук, инкапсулирующий всю логику расчетов финансовой модели.
    *   **`types/`**: Определения TypeScript типов (`FinancialTypes.ts`).
    *   **`tests/`**: Юнит-тесты.

## 3. Управление состоянием и потоком данных

*   **`FinancialContext.tsx`**: Является центральным хранилищем состояния для большинства параметров финансовой модели.
    *   Предоставляет значения параметров и функции для их изменения.
    *   Инициализирует состояние значениями по умолчанию из `constants/DefaultValues.ts`.
    *   Сеттеры параметров (например, `setTaxMode`) являются обертками, которые после обновления состояния вызывают `calculateFinancialModel()` с помощью `setTimeout(..., 0)`. Это сделано для запуска пересчета модели после изменения любого параметра.
*   **`useFinancialModel.ts`**: Кастомный хук, отвечающий за выполнение всех финансовых расчетов.
    *   Принимает текущие параметры модели, данные о клиентах и настройки апсейла.
    *   Возвращает рассчитанные помесячные данные (`monthlyData`), итоговые данные (`totalData`) и саму функцию `calculateFinancialModel`.
    *   Функция `calculateFinancialModel` внутри хука обернута в `useCallback` и зависит от переданных ей объектов `params`, `clients`, `upsellSettings`.
    *   **`components/FinancialDashboard.tsx`**: Актуальный основной UI-компонент.
        *   Использует `useFinancialContext` для доступа к данным (`monthlyData`, `totalData`, `activeTab`) и функции `setActiveTab`.
        *   Отвечает за рендеринг вкладок и соответствующего контента, импортируя панели и графики из других файлов в `src/components/`.
        *   Не содержит сложной логики расчетов или управления состоянием модели напрямую.

## 4. Ключевые расчеты (сосредоточены в `useFinancialModel.ts`)

*   **Клиентская база**:
    *   Приток новых клиентов по разным тарифам задается массивами на 12 месяцев.
    *   Отток (`churnRate`) применяется ежемесячно к активной базе.
    *   Активные клиенты = (активные клиенты прошлого месяца - отток) + новые клиенты.
*   **Доходы**:
    *   **Интеграция**: `totalNewClients * integrationPrice`.
    *   **Подписка (пакеты сообщений)**: Сумма по всем тарифам (`activeClients_N * subscriptionPrice_N`).
    *   **Дополнительные сообщения**: Рассчитываются на основе `messageUsageRate`, `carryOverPercentage` и `additionalMessagePrice`. Логика учитывает перенос неиспользованных сообщений.
    *   **Upsell**: Декомпозирован на 4 типа (доп. боты, новые функции, расширение сообщений, доп. интеграции). Каждый тип имеет свою ставку (% клиентов в месяц) и средний чек. Рассчитывается от `totalActiveClients`.
*   **Расходы**:
    *   **API**: `% от subscriptionRevenue` (в `src/FinancialDashboard.tsx`) или `% от (subscriptionRevenue + additionalMessagesRevenue)` (в `useFinancialModel.ts`).
    *   **CAC (Customer Acquisition Cost)**: Декомпозирован на:
        *   Партнерские комиссии (`% от integrationRevenue`).
        *   Зарплата продаж (`% от subscriptionRevenue` в `src/FinancialDashboard.tsx` или `% от totalRevenue` в `useFinancialModel.ts`).
        *   Маркетинг (`% от integrationRevenue`).
        *   Лидогенерация (`сумма_на_клиента * totalNewClients`).
    *   **Имплементация**: `% от integrationPrice`, но не более `maxImplementationCost` на клиента.
    *   **ФОТ**: Задается массивами на 12 месяцев для оптимистичного и пессимистичного сценариев.
*   **Прибыль**:
    *   Валовая прибыль = `totalRevenue - totalExpenses`.
    *   Налоги = `totalRevenue * taxRate` (в `src/FinancialDashboard.tsx`) или `grossProfit * taxRate` (в `useFinancialModel.ts`, если `grossProfit > 0`).
    *   Чистая прибыль = `grossProfit - tax`.
*   **KPI**:
    *   ARPU, LTV, ROI, NRR, CAC Payback Period, точка безубыточности, маржа внедрения.

## 5. Потенциальные проблемные места и вопросы для исследования

1.  **Структура файлов и использование компонентов**:
    *   Файл `src/FinancialDashboard.tsx` (прочитанный ранее) является устаревшим или неиспользуемым. Основной фокус анализа должен быть на `src/components/FinancialDashboard.tsx` и связанных с ним `FinancialContext.tsx`, `useFinancialModel.ts`, а также на компонентах панелей и графиков в `src/components/`.
    *   **Необходимо прочитать код компонентов панелей и графиков** (например, `SettingsPanel.tsx`, `RevenueChart.tsx` и т.д.), так как они могут содержать UI-логику или специфичные для них расчеты/форматирование, которые могут быть источником багов.
2.  **Управление состоянием и пересчеты (в `FinancialContext.tsx` и `useFinancialModel.ts`)**:
    *   В `FinancialContext.tsx`: Использование `setTimeout(calculateFinancialModel, 0)` для запуска пересчета после обновления состояния. Это не всегда надежно и может быть заменено на `useEffect` с правильными зависимостями, чтобы пересчет происходил синхронно с изменениями данных, от которых он зависит.
    *   В `FinancialContext.tsx`: `useEffect` для первоначального расчета `calculateFinancialModel` имеет комментарий `eslint-disable-next-line react-hooks/exhaustive-deps`. Это может скрывать проблему с отсутствием `calculateFinancialModel` в зависимостях, что может привести к использованию устаревшей версии функции, если она не обернута в `useCallback` в `useFinancialModel` (хотя она обернута).
    *   В `useFinancialModel.ts`: Зависимости `useCallback` для `calculateFinancialModel` (`clients`, `params`, `upsellSettings`). Если эти объекты часто пересоздаются в `FinancialContext` (например, если сеттеры в контексте неаккуратно обновляют объекты целиком вместо изменения полей), это приведет к частому пересозданию `calculateFinancialModel` и потенциально лишним пересчетам.
3.  **Логика расчетов**:
    *   **Налоги**: Расчет налогов отличается в `src/FinancialDashboard.tsx` (от `totalRevenue`) и `useFinancialModel.ts` (от `grossProfit`). Нужно проверить, какой подход корректен. Обычно налоги на прибыль считаются от прибыли, а не от выручки (если это не налог с оборота).
    *   **API Costs**: База для расчета API costs отличается (`subscriptionRevenue` vs `subscriptionRevenue + additionalMessagesRevenue`).
    *   **Sales Team Costs**: База для расчета зарплаты продаж отличается (`subscriptionRevenue` vs `totalRevenue`).
    *   **Округления**: `Math.round` используется в нескольких местах. Необходимо убедиться, что это не приводит к накоплению ошибок или искажению результатов, особенно при малых числах.
    *   **Деление на ноль**: В `src/FinancialDashboard.tsx` есть проверки на деление на ноль при расчете ARPU, LTV, ROI и т.д. В `useFinancialModel.ts` также есть подобные проверки. Важно проверить все места, где возможно деление на ноль.
    *   **Логика оттока в `useFinancialModel.ts`**: `churnClients75`, `churnClients150` и т.д. рассчитываются корректно для каждого месяца. Это отличается от накопительной логики `churnedClientsTotal` в устаревшем `src/FinancialDashboard.tsx`.
    *   **NRR в `useFinancialModel.ts`**: Расчет NRR выглядит сложным и зависит от `previousMonthMRR`. Требует внимательной проверки.
    *   **LTV в `useFinancialModel.ts`**: `ltv = avgArpu * 36`. Период 36 месяцев – это допущение, которое может быть неявным для пользователя.
4.  **Типизация**:
    *   Хотя `FinancialContext.tsx` и `useFinancialModel.ts` используют типы, необходимо проверить, насколько полно и корректно они применяются во всех связанных компонентах (панелях, графиках). Устаревший `src/FinancialDashboard.tsx` содержал `any[]` и `any`.
5.  **Производительность**:
    *   Множество компонентов `EditableCell` (если они используются в панелях типа `ClientsEditor`, `FOTEditor`) могут вызывать частые пересчеты всей модели при каждом изменении значения в одной ячейке, так как сеттеры в `FinancialContext` вызывают `calculateFinancialModel`. Это может быть неэффективно. Необходимо проверить, как реализованы эти панели.
6.  **UX и UI**:
    *   Логика `handleMaxImplementationChange` из устаревшего `src/FinancialDashboard.tsx` (установка 200 при вводе 0) – если подобная логика есть в актуальных компонентах, она должна быть явной.
    *   Объект `theme` импортируется из `../constants` в `components/FinancialDashboard.tsx`, что является хорошей практикой.
7.  **Версионирование TypeScript**:
    *   Используется TypeScript `^4.9.5`. Более новые версии (5.x) могли бы предложить улучшения в типизации и возможностях языка.

## 6. Дальнейшие шаги для поиска багов

1.  **Чтение кода компонентов**: Прочитать код ключевых компонентов из `src/components/panels/` (например, `SettingsPanel.tsx`, `EditableCell.tsx` (если он в `common/`), `ClientsEditor.tsx`, `FOTEditor.tsx`) и `src/components/charts/` для понимания их внутренней логики и взаимодействия с `FinancialContext`.
2.  **Статический анализ**: Запустить TypeScript компилятор (`tsc --noEmit`) и ESLint для выявления очевидных ошибок типов и проблем с кодом во всем проекте.
3.  **Детальный анализ логики расчетов**: Внимательно пройти по формулам в `useFinancialModel.ts`, сравнивая их с ожидаемой бизнес-логикой. Особое внимание уделить различиям в расчетах (налоги, API costs, sales team costs) между актуальной логикой и той, что была в устаревшем `src/FinancialDashboard.tsx`, если это важно для понимания эволюции проекта.
4.  **Тестирование граничных условий**: Продумать, как модель ведет себя при нулевых или экстремальных значениях входных параметров, особенно в контексте формул из `useFinancialModel.ts`.
5.  **Анализ управления состоянием**: Проверить корректность зависимостей `useEffect`, `useCallback` и логику обновления состояния в `FinancialContext.tsx` и `useFinancialModel.ts`.
6.  **Проверка типов**: Убедиться в отсутствии `any` в актуальных компонентах и полноте типизации.
7.  **Анализ производительности**: Оценить, нет ли избыточных перерисовок или слишком частых пересчетов модели, особенно при взаимодействии с `EditableCell` в панелях.

Этот документ будет обновляться по мере получения новой информации.
